#!/bin/bash
set -e

FORCE=0
if [[ "$1" == "--force" || "$1" == "-f" ]]; then
    FORCE=1
fi

# Determine pi agent directory (respects PI_CODING_AGENT_DIR env var)
PI_DIR="${PI_CODING_AGENT_DIR:-$HOME/.pi/agent}"

# Expand tilde if present
PI_DIR="${PI_DIR/#\~/$HOME}"

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "Installing pi-plugins symlinks..."
echo "  Source: $SCRIPT_DIR"
echo "  Target: $PI_DIR"

# Create pi agent directory if it doesn't exist
mkdir -p "$PI_DIR"

# Directories to symlink
DIRS=(extensions prompts skills)

for dir in "${DIRS[@]}"; do
    src="$SCRIPT_DIR/$dir"
    dst="$PI_DIR/$dir"
    
    if [[ ! -d "$src" ]]; then
        echo "  Skipping $dir/ (not found)"
        continue
    fi
    
    if [[ -L "$dst" ]]; then
        # Already a symlink - check if it points to the right place
        existing="$(readlink "$dst")"
        if [[ "$existing" == "$src" ]]; then
            echo "  $dir/ already linked"
        elif [[ $FORCE -eq 1 ]]; then
            rm "$dst"
            ln -s "$src" "$dst"
            echo "  $dir/ -> relinked (was: $existing)"
        else
            echo "  $dir/ symlink exists but points elsewhere: $existing"
            echo "    Run with --force to overwrite"
        fi
    elif [[ -e "$dst" ]]; then
        if [[ $FORCE -eq 1 ]]; then
            rm -rf "$dst"
            ln -s "$src" "$dst"
            echo "  $dir/ -> linked (removed existing)"
        else
            echo "  $dir/ exists and is not a symlink"
            echo "    Back it up and run with --force to overwrite"
        fi
    else
        ln -s "$src" "$dst"
        echo "  $dir/ -> linked"
    fi
done

echo "Done."
